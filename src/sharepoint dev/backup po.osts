/**
 * PO æ•°æ®é¡¹ç›®æ¥å£
 */
interface POItem {
    [key: string]: string | undefined;
}

/**
 * è§„èŒƒåŒ– JSON å­—ç¬¦ä¸²ï¼Œå¤„ç†å¤šå±‚è½¬ä¹‰å’ŒåµŒå¥—æ•°ç»„æ ¼å¼
 */
function normalizeSourceData(data: string): unknown {
    try {
        const trimmed = data.trim();

        // æƒ…å†µ 1ï¼šå¤„ç† ["..."] è¿™ç§ stringify æ ¼å¼
        if (trimmed.startsWith('[')) {
            const parsed: unknown = JSON.parse(trimmed);
            if (Array.isArray(parsed) && parsed.length > 0 && typeof parsed[0] === 'string') {
                console.log("âš ï¸  æ£€æµ‹åˆ° JSON åºåˆ—åŒ–çš„å­—ç¬¦ä¸²æ•°ç»„æ ¼å¼ï¼Œæ­£åœ¨è§£æ...");
                // é€’å½’å¤„ç†ï¼Œå¯èƒ½æœ‰å¤šå±‚è½¬ä¹‰
                return normalizeSourceData(parsed[0]);
            }
        }

        // æƒ…å†µ 2ï¼šå¤„ç†åŒå±‚è½¬ä¹‰çš„ JSON
        if (trimmed.startsWith('"[')) {
            const unescaped: unknown = JSON.parse(trimmed);
            if (typeof unescaped === 'string') {
                console.log("âš ï¸  æ£€æµ‹åˆ°è½¬ä¹‰çš„ JSON å­—ç¬¦ä¸²ï¼Œæ­£åœ¨è§£æ...");
                return normalizeSourceData(unescaped);
            }
        }

        // æƒ…å†µ 3ï¼šç›´æ¥è§£æ JSON
        return JSON.parse(trimmed);
    } catch (e) {
        console.log(`âŒ normalizeSourceData å‡ºé”™:`, e);
        throw e;
    }
}

/**
 * è§£æ PO æ•°æ®æ•°ç»„ï¼Œæå–æ¯ä¸ª PO é¡¹ç›®
 */
function parsePODataArray(jsonString: string): Array<{
    [key: string]: string;
}> {
    try {
        const data = normalizeSourceData(jsonString);

        if (!Array.isArray(data)) {
            console.log(`âŒ æœŸæœ›æ•°ç»„æ ¼å¼ï¼Œä½†æ”¶åˆ°: ${typeof data}`);
            throw new Error("Expected array of PO objects");
        }

        console.log(`âœ“ è§£æ PO æ•°æ®æ•°ç»„ï¼Œå…± ${data.length} é¡¹`);

        const poItems = data.map((item: unknown, index: number) => {
            try {
                if (typeof item !== 'object' || item === null) {
                    throw new Error(`é¡¹ç›® ${index} ä¸æ˜¯å¯¹è±¡`);
                }

                const po = item as POItem;
                
                // å»ºç«‹æ–°å¯¹è±¡ï¼Œä¿ç•™æ‰€æœ‰å­—æ®µå¹¶ trim å­—ç¬¦ä¸²å€¼
                const result: { [key: string]: string } = {};
                for (const key in po) {
                    const value = po[key];
                    result[key] = (typeof value === 'string') ? value.trim() : (value ?? '');
                }
                
                return result;
            } catch (e) {
                console.log(`  âš ï¸  å¤„ç†é¡¹ç›® ${index} æ—¶å‡ºé”™:`, e);
                throw e;
            }
        });

        return poItems;
    } catch (e) {
        console.log(`âŒ parsePODataArray å‡ºé”™:`, e);
        throw e;
    }
}

function main(
    workbook: ExcelScript.Workbook,
    sourceData: string[]
) {

    // ============ è°ƒè¯•ï¼šæ£€æŸ¥ä¼ å…¥çš„æ•°æ®ç»“æ„ ============
    console.log(`ğŸ“Š sourceData ç±»å‹: ${typeof sourceData}, isArray: ${Array.isArray(sourceData)}`);
    console.log(`ğŸ“Š sourceData.length: ${sourceData.length}`);
    
    if (sourceData.length > 0) {
        console.log(`ğŸ“Š sourceData[0] ç±»å‹: ${typeof sourceData[0]}`);
        console.log(`ğŸ“Š sourceData[0] é•¿åº¦: ${sourceData[0]?.length || 0}`);
        console.log(`ğŸ“Š sourceData[0] å‰ 200 å­—ç¬¦: ${sourceData[0]?.substring(0, 200)}...`);
        
        // å°è¯•è§£æç¬¬ä¸€é¡¹
        try {
            const parsed: unknown = JSON.parse(sourceData[0]);
            console.log(`âœ“ JSON è§£ææˆåŠŸ`);
            console.log(`âœ“ è§£æç»“æœç±»å‹: ${typeof parsed}`);
            console.log(`âœ“ æ˜¯æ•°ç»„: ${Array.isArray(parsed)}`);
            if (Array.isArray(parsed)) {
                console.log(`âœ“ æ•°ç»„é•¿åº¦: ${parsed.length}`);
                if (parsed.length > 0) {
                    console.log(`âœ“ ç¬¬ä¸€é¡¹ç±»å‹: ${typeof parsed[0]}`);
                    if (typeof parsed[0] === 'string') {
                        console.log(`âœ“ ç¬¬ä¸€é¡¹å€¼ï¼ˆå‰ 100 å­—ç¬¦ï¼‰: ${parsed[0].substring(0, 100)}...`);
                    }
                }
            }
        } catch (parseError) {
            console.log(`âš ï¸  JSON è§£æå¤±è´¥: ${parseError}`);
        }
    }

    // ============ é˜¶æ®µ 1ï¼šè§£æ PO æ•°æ® ============
    if (!sourceData || sourceData.length === 0) {
        console.log("âŒ é”™è¯¯ï¼šsourceData ä¸ºç©º");
        return;
    }

    try {
        console.log("ğŸ“‹ [é˜¶æ®µ 1] è§£æ PO æ•°æ®...");
        
        // å…ˆæ£€æŸ¥åŸå§‹æ•°æ®çš„é•¿åº¦
        const rawData: unknown = normalizeSourceData(sourceData[0]);
        let rawDataCount = 0;
        if (Array.isArray(rawData)) {
            rawDataCount = rawData.length;
            console.log(`âœ“ åŸå§‹æ•°æ®æ•°ç»„é•¿åº¦: ${rawDataCount} é¡¹`);
        }
        
        const poItems = parsePODataArray(sourceData[0]);
        console.log(`âœ“ æˆåŠŸè§£æ ${poItems.length} ä¸ª PO é¡¹ç›®`);
        
        // æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸¢å¤±
        if (rawDataCount !== poItems.length) {
            console.log(`âš ï¸  è­¦å‘Šï¼šæ•°æ®ä¸¢å¤±ï¼åŸå§‹ ${rawDataCount} é¡¹ â†’ è§£æå ${poItems.length} é¡¹ï¼ˆä¸¢å¤± ${rawDataCount - poItems.length} é¡¹ï¼‰`);
        }

        // è¾“å‡ºå‰ 5 ä¸ªé¡¹ç›®ä½œä¸ºç¤ºä¾‹
        console.log("\nğŸ“Œ å‰ 5 ä¸ª PO é¡¹ç›®ï¼š");
        poItems.slice(0, 5).forEach((po, index) => {
            console.log(`  ã€${index}ã€‘ PO=${po['PO']}, OrderItemID=${po['Order Item ID']}, Title=${po['Title']}`);
        });

        // ============ é˜¶æ®µ 2ï¼šåˆ›å»ºå¤‡ä»½ Sheet ============
        console.log("\nğŸ“‹ [é˜¶æ®µ 2] åˆ›å»ºå¤‡ä»½ Sheet...");
        
        const PREFIX = "Backup_";
        const MAX_SHEETS = 30;

        // ç”Ÿæˆ Sheet åç§°ï¼ˆæ ¼å¼: Backup_yyyymmdd_hhmmï¼‰
        const now = new Date();
        const sheetName = PREFIX +
            now.getFullYear() +
            String(now.getMonth() + 1).padStart(2, '0') +
            String(now.getDate()).padStart(2, '0') + "_" +
            String(now.getHours()).padStart(2, '0') +
            String(now.getMinutes()).padStart(2, '0');

        console.log(`âœ“ ç”Ÿæˆ Sheet åç§°: ${sheetName}`);

        // åˆ›å»ºæ–° Sheet
        const newSheet = workbook.addWorksheet();
        newSheet.setName(sheetName);
        console.log(`âœ“ å·²åˆ›å»ºæ–° Sheet`);

        // ============ é˜¶æ®µ 3ï¼šæ„é€ è¡¨å¤´å’Œæ•°æ® ============
        console.log("\nğŸ“‹ [é˜¶æ®µ 3] æ„é€ è¡¨å¤´å’Œæ•°æ®...");
        
        // ä»ç¬¬ä¸€ä¸ª PO å¯¹è±¡åŠ¨æ€æå–æ‰€æœ‰å­—æ®µä½œä¸ºè¡¨å¤´
        let headers: string[] = [];
        if (poItems.length > 0) {
            // è§£æåŸå§‹æ•°æ®æ¥è·å–æ‰€æœ‰å­—æ®µå
            const rawData: unknown = normalizeSourceData(sourceData[0]);
            if (Array.isArray(rawData) && typeof rawData[0] === 'object' && rawData[0] !== null) {
                headers = Object.keys(rawData[0] as Record<string, unknown>)
                    .filter((key) => key !== '@odata.etag' && key !== 'ItemInternalId');
            }
        }

        if (headers.length === 0) {
            console.log("âŒ é”™è¯¯ï¼šæ— æ³•æå–è¡¨å¤´");
            return;
        }

        console.log(`âœ“ æå–è¡¨å¤´æˆåŠŸ: ${headers.length} åˆ—`);

        // æ„é€ äºŒç»´æ•°ç»„ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
        const data: (string | number | boolean)[][] = [headers as (string | number | boolean)[]];

        poItems.forEach((po) => {
            const row: (string | number | boolean)[] = [];
            headers.forEach((header) => {
                row.push(po[header] ?? '');
            });
            data.push(row);
        });

        console.log(`âœ“ æ•°æ®æ„é€ å®Œæ¯•: ${data.length} è¡Œï¼ˆå«è¡¨å¤´ï¼‰ï¼Œ${headers.length} åˆ—`);

        // ============ é˜¶æ®µ 4ï¼šå†™å…¥ Sheet ============
        console.log("\nğŸ“‹ [é˜¶æ®µ 4] å†™å…¥æ•°æ®...");
        
        const range = newSheet.getRangeByIndexes(0, 0, data.length, headers.length);
        range.setValues(data);
        console.log(`âœ“ æ•°æ®å·²å†™å…¥ Sheet`);

        // ============ é˜¶æ®µ 5ï¼šæ£€æŸ¥å¹¶æ¸…ç†æ—§å¤‡ä»½ ============
        console.log("\nğŸ“‹ [é˜¶æ®µ 5] æ£€æŸ¥å¹¶æ¸…ç†æ—§å¤‡ä»½...");
        
        const sheets = workbook.getWorksheets();
        const backupSheets: string[] = [];

        for (let i = 0; i < sheets.length; i++) {
            const name = sheets[i].getName();
            if (name.startsWith(PREFIX)) {
                backupSheets.push(name);
            }
        }

        console.log(`âœ“ å½“å‰å¤‡ä»½æ•°é‡: ${backupSheets.length}`);

        // æŒ‰åç§°æ’åºï¼ˆæ—¶é—´æ ¼å¼å­—ç¬¦ä¸²å¯ä»¥ç›´æ¥æ’åºï¼‰
        backupSheets.sort();

        // å¦‚æœè¶…å‡ºé™åˆ¶ï¼Œåˆ é™¤æœ€è€çš„
        if (backupSheets.length > MAX_SHEETS) {
            const deleteCount = backupSheets.length - MAX_SHEETS;
            console.log(`âš ï¸  è¶…è¿‡é™åˆ¶ ${MAX_SHEETS}ï¼Œå°†åˆ é™¤ ${deleteCount} ä¸ªæœ€æ—§çš„å¤‡ä»½`);

            for (let i = 0; i < deleteCount; i++) {
                const sheetToDelete = workbook.getWorksheet(backupSheets[i]);
                if (sheetToDelete) {
                    console.log(`  ğŸ—‘ï¸  åˆ é™¤: ${backupSheets[i]}`);
                    sheetToDelete.delete();
                }
            }
        }

        console.log(`\nâœ… å¤‡ä»½å®Œæˆï¼æ–° Sheet: ${sheetName}`);

    } catch (e) {
        console.log(`âŒ è„šæœ¬æ‰§è¡Œå‡ºé”™: ${e}`);
        return;
    }
}

