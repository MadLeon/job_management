# 任务清单: 数据库规范化重构

## 阶段 1: 方案评审与确认

### 任务 1.1: 审核数据库设计提案
- [ ] 审查 15 个新表的结构定义
- [ ] 确认外键约束和级联删除策略
- [ ] 确认唯一约束和索引设计
- [ ] 确认三范式符合性
- **输出**: proposal.md 和 design.md 的审核确认

### 任务 1.2: 确认数据迁移策略
- [ ] 决定是否保留旧数据库（用于参考）
- [ ] 决定历史数据处理方式
- [ ] 确认没有关键数据会丢失
- **输出**: 迁移策略文档

### 任务 1.3: 评估应用代码改造工作量
- [ ] 列出需要改造的 API 路由
- [ ] 列出需要改造的前端组件
- [ ] 识别优先级最高的功能
- **输出**: 代码改造优先级列表

---

## 阶段 2: 新数据库初始化

### 任务 2.1: 删除所有旧迁移脚本
- [ ] 删除 `scripts/migrations/` 下的所有 `.js` 文件（001-019）
- [ ] 重置 `data/migrations.json` 为初始状态
- [ ] 验证数据库处于干净状态
- **验证**: `node scripts/check-db.js` 应显示只有旧表

### 任务 2.2: 创建新迁移脚本 #001
**内容**: 创建所有 15 个新表
- [ ] 创建 `scripts/migrations/001_create_new_database_schema.js`
- [ ] 包含所有表的创建 SQL（customer, customer_contact, purchase_order, job, order_item, part, part_tree, shipment, shipment_item, part_attachment, drawing_file, folder_mapping, process_template, step_tracker, note）
- [ ] 包含所有 UNIQUE 约束和 FOREIGN KEY 约束
- [ ] 验证迁移可以正常 `up` 和 `down`
- **测试**: `npm run db:migrate` 应成功创建所有表

### 任务 2.3: 创建索引迁移脚本 #002
**内容**: 创建性能优化索引（可选，但推荐）
- [ ] 创建 `scripts/migrations/002_create_database_indices.js`
- [ ] 包含外键索引、业务查询索引等
- [ ] 验证索引创建成功
- **测试**: `node scripts/check-db.js` 应显示新表和索引

---

## 阶段 3: 数据迁移脚本（如需要）

### 任务 3.1: 编写 ETL 脚本（可选）
- [ ] 如果需要保留旧数据，创建 `scripts/migrations/003_migrate_old_data.js`
- [ ] 将 `jobs` 表的数据映射到新表
  - `customer_name` → `customer` 表
  - `customer_contact` → `customer_contact` 表
  - `po_number` → `purchase_order` 表
  - 其他字段 → `order_item` 表
- [ ] 创建 ID 映射表（旧 ID → 新 ID）以供后续应用代码参考
- [ ] 验证迁移后数据完整性
- **测试**: 检查数据映射是否正确，没有遗漏

### 任务 3.2: 验证迁移数据
- [ ] 检查所有 358 条记录是否正确映射
- [ ] 验证外键完整性
- [ ] 验证 usage_count 和 last_used 初值正确
- [ ] 对比新旧数据，确认没有数据丢失

---

## 阶段 4: 应用代码改造（并行可行）

**说明**: 以下任务可并行进行，但需要优先处理客户/搜索功能

### 任务 4.1: 更新 API 路由基础设施
- [ ] 评估现有 API 路由结构
- [ ] 计划新的 API 端点设计
- [ ] 创建数据库查询辅助函数（如 getCustomerById, getJobsByCustomer 等）
- **输出**: API 设计文档

### 任务 4.2: 改造客户相关 API
- [ ] `GET /api/customers/` - 获取客户列表（支持排序、搜索）
- [ ] `GET /api/customers/:id/` - 获取单个客户详情
- [ ] `POST /api/customers/` - 创建新客户
- [ ] `PUT /api/customers/:id/` - 更新客户
- [ ] `GET /api/customers/:id/contacts/` - 获取客户的联系人列表
- **测试**: 编写单元测试或集成测试

### 任务 4.3: 改造订单相关 API
- [ ] `GET /api/purchase-orders/` - 获取采购订单列表
- [ ] `POST /api/purchase-orders/` - 创建新采购订单
- [ ] `GET /api/jobs/` - 获取作业列表
- [ ] `POST /api/jobs/` - 创建新作业
- [ ] 更新订单状态、优先级等操作
- **测试**: 编写单元测试

### 任务 4.4: 改造订单明细和零件 API
- [ ] `GET /api/order-items/:id/` - 获取订单明细
- [ ] `GET /api/parts/` - 获取零件列表
- [ ] `POST /api/parts/` - 创建新零件
- [ ] `GET /api/parts/:id/bom/` - 获取零件 BOM
- [ ] 零件版本管理 API
- **测试**: 编写单元测试

### 任务 4.5: 改造生产追踪 API
- [ ] `GET /api/order-items/:id/steps/` - 获取订单的生产步骤
- [ ] `POST /api/order-items/:id/steps/` - 创建新步骤
- [ ] `PUT /api/steps/:id/` - 更新步骤状态
- [ ] 步骤追踪统计和报表
- **测试**: 编写单元测试

### 任务 4.6: 改造发货相关 API
- [ ] `GET /api/shipments/` - 获取发货单列表
- [ ] `POST /api/shipments/` - 创建新发货单
- [ ] `GET /api/shipments/:id/items/` - 获取发货明细
- **测试**: 编写单元测试

### 任务 4.7: 改造附件和备注 API
- [ ] `GET /api/part-attachments/` - 获取零件附件
- [ ] `POST /api/part-attachments/` - 上传新附件
- [ ] `GET /api/notes/:type/:id/` - 获取某实体的备注
- [ ] `POST /api/notes/` - 创建新备注
- **测试**: 编写单元测试

---

## 阶段 5: 前端组件改造（并行可行）

**说明**: 同时进行，优先改造常用页面

### 任务 5.1: 更新所有数据查询（React Query）
- [ ] 更新 `src/lib/hooks/` 中的所有数据获取函数
- [ ] 迁移到新的 API 端点
- [ ] 更新缓存键和查询逻辑
- **验证**: 所有页面能正常加载数据

### 任务 5.2: 改造 all-jobs 页面
- [ ] 更新作业表格的数据源
- [ ] 更新筛选条件（客户、优先级、状态等）
- [ ] 更新搜索功能
- [ ] 更新排序功能
- **测试**: 手动测试各个筛选和搜索条件

### 任务 5.3: 改造 all-customers 页面
- [ ] 创建或更新客户列表页面
- [ ] 支持按使用频率排序
- [ ] 支持搜索和筛选
- [ ] 支持添加/编辑客户
- **测试**: 手动测试各个功能

### 任务 5.4: 改造任务详情页面
- [ ] 更新作业详情页
- [ ] 显示订单明细（原来的明细行）
- [ ] 显示生产步骤追踪
- [ ] 显示相关备注
- **测试**: 手动测试详情页面

### 任务 5.5: 创建生产追踪页面（新功能）
- [ ] 创建步骤追踪界面
- [ ] 支持状态更新
- [ ] 支持记录操作员和机器信息
- [ ] 支持分批发货
- **测试**: 手动测试生产追踪功能

### 任务 5.6: 改造其他现有页面
- [ ] dashboard 页面
- [ ] watch-list 页面
- [ ] 搜索功能
- [ ] 其他依赖 `jobs` 表的页面
- **测试**: 所有页面都能正常工作

---

## 阶段 6: 验证与测试

### 任务 6.1: 数据库完整性测试
- [ ] 验证所有外键约束
- [ ] 验证唯一约束
- [ ] 验证级联删除
- [ ] 验证触发器（updated_at）
- **运行**: `node scripts/test-db.js` （如存在）

### 任务 6.2: API 路由测试
- [ ] 运行所有 API 单元测试
- [ ] 运行集成测试
- [ ] 验证错误处理
- [ ] 验证数据验证
- **运行**: `npm test`

### 任务 6.3: 前端功能测试
- [ ] 页面加载测试
- [ ] 数据显示正确性
- [ ] 增删改查操作
- [ ] 搜索筛选功能
- [ ] 跨页面导航
- **方式**: 手动黑盒测试

### 任务 6.4: 性能测试（可选）
- [ ] 测试大数据量下的查询性能
- [ ] 验证索引是否生效
- [ ] 测试复杂查询（多表 JOIN）
- **工具**: SQLite 性能分析工具

---

## 阶段 7: 上线和文档

### 任务 7.1: 更新数据库文档
- [ ] 更新 `data/structure.txt`，反映新的数据库结构
- [ ] 添加 API 文档（端点列表、参数说明）
- [ ] 添加数据模型文档
- **输出**: 完整的数据库和 API 文档

### 任务 7.2: 更新项目配置和说明
- [ ] 更新 `openspec/project.md`
- [ ] 更新 README（如需要）
- [ ] 更新开发人员指南
- **输出**: 最新的项目文档

### 任务 7.3: 部署准备
- [ ] 确认所有测试通过
- [ ] 清理 debug 代码
- [ ] 性能优化
- [ ] 安全检查
- **输出**: 生产就绪的代码

### 任务 7.4: 上线和监控
- [ ] 备份旧数据库
- [ ] 执行新数据库迁移
- [ ] 上线新应用代码
- [ ] 监控错误和性能
- [ ] 准备回滚方案
- **输出**: 成功的生产部署

---

## 任务优先级和依赖关系

```
阶段 1 (评审)
  ↓
阶段 2 (初始化) ──┬─→ 阶段 3 (数据迁移)
  ↓                ↓
  └──────────────┬─→ 阶段 4 & 5 (并行改造)
                  ↓
              阶段 6 (测试)
                  ↓
              阶段 7 (上线)
```

**关键路径**:
1. ✅ 阶段 1: 方案评审（等待用户批准）
2. ✅ 阶段 2: 数据库初始化（3-4 小时）
3. ⏳ 阶段 3: 数据迁移（如需要，2-3 小时）
4. ⏳ 阶段 4 & 5: 应用改造（2-4 周，取决于应用复杂度）
5. ✅ 阶段 6: 测试验证（1-2 周）
6. ✅ 阶段 7: 上线（1 天）

---

## 评分与验收标准

### 阶段 2 验收
- ✅ 所有 15 个新表创建成功
- ✅ 所有约束和索引生效
- ✅ `npm run db:migrate` 和 `npm run db:migrate:down` 正常工作
- ✅ `node scripts/check-db.js` 显示正确的表结构

### 阶段 4 & 5 验收
- ✅ 所有 API 端点可正常访问
- ✅ 前端页面能正常显示数据
- ✅ 增删改查操作正常工作
- ✅ 没有 console errors 或 warnings
- ✅ 单元测试覆盖率 ≥ 80%

### 阶段 6 验收
- ✅ 所有测试用例通过
- ✅ 数据库约束生效
- ✅ 没有数据丢失或不一致
- ✅ 性能满足要求

### 阶段 7 验收
- ✅ 生产环境部署成功
- ✅ 用户反馈正面
- ✅ 没有关键错误或数据问题

---

## 工作量估算

| 阶段 | 任务数 | 估算工作量 | 依赖项 |
|------|--------|-----------|---------|
| 1 | 3 | 2 小时 | 用户审核 |
| 2 | 3 | 3-4 小时 | 阶段 1 完成 |
| 3 | 2 | 2-3 小时 | 阶段 2 完成 |
| 4 | 7 | 40-50 小时 | 阶段 2 完成 |
| 5 | 6 | 30-40 小时 | 阶段 4 并行 |
| 6 | 4 | 15-20 小时 | 阶段 4 & 5 完成 |
| 7 | 4 | 4-6 小时 | 阶段 6 完成 |
| **总计** | **29** | **96-127 小时** | **约 2-3 周** |

---

## 需要用户确认的事项

在执行任务前，请确认以下问题：

1. **数据保留**: 是否需要保留旧 `jobs` 表中的 358 条记录？如何迁移？
2. **历史数据**: `job_history` 表中有数据吗？如何处理？
3. **ID 映射**: 迁移后是否需要保留旧 ID → 新 ID 的映射？
4. **并行开发**: 应用代码改造是否可以与新数据库并行开发？
5. **上线时间**: 预期的上线时间是什么？需要保留旧系统的并行运行吗？
6. **功能优先级**: 阶段 4 & 5 中哪些功能优先级最高，应该先完成？
7. **生产数据**: 是否有其他外部数据源需要导入新数据库？

---

**更新日期**: 2025-01-06
**状态**: 待用户评审和批准
